language: php
sudo: false
dist: xenial

addons:
  apt:
    update: true
    packages:
      - python-sphinx
      - python-babel
      - doxygen
      - graphviz
      - texlive-latex-base
      - texlive-latex-recommended
      - texlive-latex-extra
      - texlive-fonts-recommended
      - texlive-lang-french
      - texlive-lang-english

notifications:
  email: false

php:
  - 7

script:
  - rm composer.lock
  - composer self-update -n
  - composer install -n
  - export GHPAGES=`mktemp -d -p "docs/"`
  - export DEFAULT_BRANCH=`git symbolic-ref --short refs/remotes/origin/HEAD | cut -d/ -f2-`
  - git clone --branch=gh-pages https://github.com/${TRAVIS_REPO_SLUG}.git "$GHPAGES/"
  - rm -rf "$GHPAGES/.git"
  - rm -rf "$GHPAGES/${TRAVIS_REPO_SLUG}/refs/${TRAVIS_BRANCH}"
  - cd docs/src/
  - for lang in fr en; do for builder in html latex; do sphinx-build -T -E -b $builder -d ../_build/doctrees -D language=$lang . "../../$GHPAGES/${TRAVIS_REPO_SLUG}/refs/${TRAVIS_BRANCH}/$lang/$builder"; done; make -C "../../$GHPAGES/${TRAVIS_REPO_SLUG}/refs/${TRAVIS_BRANCH}/$lang/latex/" all-pdf < /dev/null; find "../../$GHPAGES/${TRAVIS_REPO_SLUG}/refs/${TRAVIS_BRANCH}/$lang/latex/" ! -name "*.pdf"; done
  - cd ../..
  - if [ -n "$TRAVIS_TAG" ]; then ln -sfT "refs/${TRAVIS_BRANCH}" "$GHPAGES/${TRAVIS_REPO_SLUG}/stable"; else ln -sfT "refs/${TRAVIS_BRANCH}" "$GHPAGES/${TRAVIS_REPO_SLUG}/latest"; fi
  - touch "$GHPAGES/.nojekyll"
  - printf "%s" '<html><head><meta http-equiv="refresh" content="0; url=latest/en/html/"/></head><body onload="window.location.replace('"'"'latest/en/html/'"'"');"></body></html>' > "$GHPAGES/${TRAVIS_REPO_SLUG}/index.html"

deploy:
  local-dir: $GHPAGES
  provider: pages
  #repo: Erebot/erebot.github.io
  skip-cleanup: true
  github-token: $GITHUB_TOKEN
  keep-history: true
  verbose: true
  on:
    branch: master
